extends layout

block content
  .container-fluid
    h1 Alertas
    div(class="alert alert-warning fade show", id="CuadroAlerta", style="display: none;")
      span(id="txtResultado") Demos
      button(type="button", class="close", id="btnCerrar")
        span(aria-hidden="true") &times;
    .btn-group
      input.btn.btn-outline-primary(type="button", value="Alerta", id="btnAlert")
      input.btn.btn-outline-primary(type="button", value="Confirmación", id="btnConfirm")
      input.btn.btn-outline-primary(type="button", value="Petición", id="btnPrompt")
    input.btn.btn-outline-danger(type="button", value="Excepción no controlada", id="btnExcepcion")
    h1 Cuadros emergentes
    .btn-group
      input.btn.btn-outline-success(type="button", data-toggle="modal", data-target="#staticBackdrop", value="Mostra cuadro modal")
      input.btn.btn-outline-success(type="button", data-toggle="modal", data-target="#exampleModal", data-whatever="@mdo", value="Mostra cuadro modeless")
    h1 Temporizadores
    div.alert.alert-success
      b Hora: 
      span(id="currentDate")
      | &nbsp;
      output.badge.badge-pill.badge-info(id="crono") 0 seconds
      | &nbsp;
      button.btn.btn-primary.btn-sm(type='button', id='btnParar')
        | Parar
      | &nbsp;
      b Oferta: 
      | &nbsp;
      output(id="txtOferta") Quedan 5 minutos
      | &nbsp;
      button.btn.btn-success.btn-sm(type='button', id='btnComprar')
        | Compro
    div.modal.fade(id="staticBackdrop", data-backdrop="static", data-keyboard="false", tabindex="-1", role="dialog", aria-labelledby="staticBackdropLabel", aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title(id="staticBackdropLabel") New message
            button(type="button", class="close", data-dismiss="modal", aria-label="Close")
              span(aria-hidden="true") &times;
          .modal-body
            p I will not close if you click outside me. Don't even try to press escape key.
          .modal-footer
            button(type="button", class="btn btn-secondary", data-dismiss="modal") Close
            button(type="button", class="btn btn-primary") Understood
    div(class="modal fade", id="exampleModal", tabindex="-1", role="dialog", aria-labelledby="exampleModalLabel", aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title(id="exampleModalLabel") New message
            button(type="button", class="close", data-dismiss="modal", aria-label="Close")
              span(aria-hidden="true") &times;
          .modal-body
            form
              .form-group
                label.col-form-label(for="recipient-name") Recipient:
                input.form-control(type="text", id="recipient-name")
              .form-group
                label.col-form-label(for="message-text") Message:
                textarea.form-control(id="message-text")
          .modal-footer
            button(type="button", class="btn btn-secondary", data-dismiss="modal") Close
            button(type="button", class="btn btn-primary") Send message
    link(rel='stylesheet', href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css')
    h1 Mi ubicación actual en OpenStreetMap
    ul
      li 
        output(id="txtPosicion") Geolocalización
      li 
        output(id="txtUbicacion") Geolocalización
    #map(style='width: 100%; height: 400px;')
    script(src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js')

block scripts
  script.
    $(document).ready(function() {
      $("#currentDate").text(new Date().toISOString().substring(0, 16));
      setInterval(() => {
        $("#currentDate").text(new Date().toISOString().substring(0, 16));
      }, 60000);
      let seconds = 0;
      const ponInterval = () => {
        return setInterval(() => {
          $("#crono").text(++seconds + " seconds");
        }, 1000);
      }
      let intervalo = ponInterval();
      $("#btnParar").click(function (ev) {
        if ($("#btnParar").text() === "Parar") {
          clearInterval(intervalo);
          $("#btnParar").text("Continuar");
        } else {
          intervalo = ponInterval();
          $("#btnParar").text("Parar");
        }
      });
      let oferta = 5;
      let ofertaTimer;
      const ofertafn = () => {
        if (!--oferta){ 
          $("#txtOferta").text("Se ha terminado");
          $("#btnComprar").hide()
          return
        }
        $("#txtOferta").text(
          oferta > 1 ? "Quedan " + oferta + " minutos" : "Último minuto"
        );
        setTimeout(ofertafn, 60000);
      };
      ofertaTimer = setTimeout(ofertafn, 60000);
      $('#btnComprar').click(function(ev) {
        clearTimeout(ofertaTimer)
        $("#txtOferta").text("Comprado");
        $('#btnComprar').hide();

      });
      
      $('#btnCerrar').click(function(ev) {
        $('#CuadroAlerta').hide();
      });
      $('#btnAlert').click(function(ev) {
        alert('Esta es una alerta');
        $('#txtResultado').text('Se ha cerrado la alerta');
        $('#CuadroAlerta').removeClass().addClass( "alert alert-warning fade show" ).show();
      });
      $('#btnConfirm').click(function(ev) {
        if (window.confirm("¿Estas seguro?")) { 
          $('#txtResultado').text('Respuesta positiva');
          $('#CuadroAlerta').removeClass().addClass( "alert alert-success fade show" ).show();
        } else {
          $('#txtResultado').text('Respuesta negativa');          
          $('#CuadroAlerta').removeClass().addClass( "alert alert-danger fade show" ).show();
        }
        
      });
      $('#btnPrompt').click(function(ev) {
        let result = window.prompt("Dime algo:");
        if (result === null) { 
          $('#txtResultado').text('Has cancelado');
          $('#CuadroAlerta').removeClass().addClass( "alert alert-warning fade show" ).show();
        } else if (result === '') {
          $('#txtResultado').text('Has aceptado sin decir nada');          
          $('#CuadroAlerta').removeClass().addClass( "alert alert-danger fade show" ).show();
        } else {
          $('#txtResultado').text('Has dicho: ' + result); 
          $('#CuadroAlerta').removeClass().addClass( "alert alert-success fade show" ).show();
        }
      });
      $('#btnExcepcion').click(function(ev) {
        throw new Error('Excepción no controlada')
      });
      $('#myModal').on('shown.bs.modal', function () {
        $('#myInput').trigger('focus')
      })
      $('#exampleModal').on('show.bs.modal', function (event) {
        let button = $(event.relatedTarget) // Button that triggered the modal
        let recipient = button.data('whatever') // Extract info from data-* attributes
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        let modal = $(this)
        modal.find('.modal-title').text('New message to ' + recipient)
        modal.find('.modal-body input').val(recipient)
      })
      // Crear el mapa
      if (!navigator.geolocation) {
        $('#txtPosicion').text('Geolocation is not supported by your browser');
      } else {
        $('#txtPosicion').text('Geolocation is supported by your browser');
        navigator.geolocation.getCurrentPosition((position) => {
          $('#txtPosicion').text(`Geolocalización (latitude: ${position.coords.latitude}, longitude: ${position.coords.longitude})`)
          fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json&accept-language=es`)
            .then(response => {
                    if (response.ok) {
                        response.json().then(data => $('#txtUbicacion').text(data.display_name))
                    } else {
                        $('#txtUbicacion').text(`ERROR`)
                    }
                })
        }, err => {
          switch(err.code) {
            case 1: $('#txtPosicion').text(`PERMISSION DENIED: ${err.message}`); break;
            case 2: $('#txtPosicion').text(`POSITION UNAVAILABLE: ${err.message}`); break;
            case 3: $('#txtPosicion').text(`TIMEOUT: ${err.message}`); break;
            default: $('#txtPosicion').text(`ERROR: ${err.message}`); break;
          }
        });
      }
      const map = L.map("map").setView([0, 0], 2);
       // Cargar los tiles de OSM
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "© OpenStreetMap",
      }).addTo(map);
      map.locate({setView: true, maxZoom: 15}); // Intentar geolocalizar al usuario
      map.on("locationfound", function (e) { // Si encuentra la ubicación
        L.marker(e.latlng).addTo(map).bindPopup("Estás aquí").openPopup();
        L.circle(e.latlng, {radius: e.accuracy}).addTo(map);
      });
      map.on("locationerror", function () { // Si ocurre un error
        alert("No se pudo obtener tu ubicación.");
      });
    });
